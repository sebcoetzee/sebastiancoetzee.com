<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>RabbitMQ as a message broker for Ruby and Node.js</title>

  <meta name="author" content="Sebastian Coetzee" />

  

  <link rel="alternate" type="application/rss+xml" title="Sebastian Coetzee - Software Developer living in London" href="/feed.xml" />

  
    
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />
    
  

  
    
      <link rel="stylesheet" href="/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/css/main.css" />
    
  

  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

  

  

  

    <!-- Facebook OpenGraph tags -->
  

  
  <meta property="og:title" content="RabbitMQ as a message broker for Ruby and Node.js" />
  

   
  <meta property="og:description" content="The Backstory I am busy building a SaaS product that has to reliably send large numbers of emails. At ZappiStore we use the Ruby on Rails stack extensively. I think Rails is an excellent choice for building web applications. Rails makes you super productive and the community support is excellent....">
  


  <meta property="og:type" content="website" />

  
  <meta property="og:url" content="https://sebastiancoetzee.com/2016-06-12-rabbitmq-as-a-message-broker-for-ruby" />
  <link rel="canonical" href="https://sebastiancoetzee.com/2016-06-12-rabbitmq-as-a-message-broker-for-ruby" />
  

  
  <meta property="og:image" content="https://sebastiancoetzee.com/img/avatar-icon-3.jpeg" />
  
  

  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />

  
  <meta name="twitter:title" content="RabbitMQ as a message broker for Ruby and Node.js" />
  

  
  <meta name="twitter:description" content="The Backstory I am busy building a SaaS product that has to reliably send large numbers of emails. At ZappiStore we use the Ruby on Rails stack extensively. I think Rails is an excellent choice for building web applications. Rails makes you super productive and the community support is excellent....">
  

  
  <meta name="twitter:image" content="https://sebastiancoetzee.com/img/avatar-icon-3.jpeg" />
  

</head>


  <body>
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://sebastiancoetzee.com">Sebastian Coetzee</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
            
            





<a href="/">Home</a>

          </li>
        
        
        
          <li>
            
            





<a href="/aboutme">About Me</a>

          </li>
        
        
      </ul>
    </div>

	
	<div class="avatar-container">
	  <div class="avatar-img-border">
	    <a href="https://sebastiancoetzee.com ">
	      <img class="avatar-img" src="/img/avatar-icon-3.jpeg" />
		</a>
	  </div>
	</div>
	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <h1>RabbitMQ as a message broker for Ruby and Node.js</h1>
		  
		  
		  
		  <span class="post-meta">Posted on June 12, 2016</span>
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

      <article role="main" class="blog-post">
        <h3 id="the-backstory">The Backstory</h3>

<p>I am busy building a SaaS product that has to reliably send large numbers of emails. At <a href="https://www.zappistore.com/">ZappiStore</a> we use the <a href="http://rubyonrails.org/">Ruby on Rails</a> stack extensively. I think Rails is an excellent choice for building web applications. Rails makes you super productive and the community support is excellent. Naturally I want to use Rails for the web application layer of the system. There are a couple of different options built into Rails for sending emails.</p>

<p>I don’t want a user to have to wait one or two seconds for an SMTP request to finish before they get a response, so sending will have to be done asynchronously. The ActionMailer API in Rails is built for sending emails but ideally I want to pass off the load of sending mails to something that is good at making large amounts of requests and handling them asynchronously. There is support for asynchronous requests in Ruby but it is not as geared towards it as JavaScript is. Also, since Ruby is single-threaded with a global interpreter lock, I want it to do as little processing as possible and rather play to its strengths.</p>

<p>Node.js is built from the ground up with asynchronous operations in mind. Functions are first-class citizens in JavaScript and this makes programming with callbacks easy. Therefore it is a good choice for the creation of a microservice that sends emails. I am using the <a href="https://mailgun.com">Mailgun</a> API in order to send emails using POST requests.</p>

<p>Since the web application layer is written in Ruby and I have a microservice written in Node.js, these need to pass data between one-another in some way. The communication solution should have the following properties:</p>

<ul>
  <li>Robust. If a service goes down, the message should be persisted in the queue until it is handled.</li>
  <li>Decoupled. The individual microservices should ideally not have any direct knowledge of each other. Each service should communicate via the message broker.</li>
</ul>

<p>Enter <a href="https://www.rabbitmq.com">RabbitMQ</a>. Rabbit has been around for a long time and has proven to be a high-performance and reliable message queue. The idea is to use Ruby to push a message onto the queue and then pop the message off of the queue in the Node.js microservice.</p>

<h3 id="getting-started-with-rabbitmq">Getting Started with RabbitMQ</h3>

<p>For those of us that use OS X, installing RabbitMQ is easiest done with <a href="http://brew.sh/">Homebrew</a>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>brew install rabbitmq
</code></pre>
</div>

<p>Once RabbitMQ is installed, start it up as a service with the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>brew services start rabbitmq
</code></pre>
</div>

<h3 id="the-ruby-layer">The Ruby Layer</h3>

<p>In order to connect to RabbitMQ from Ruby we are going to use the <a href="https://github.com/ruby-amqp/bunny">bunny</a> gem. Add it to your <code class="highlighter-rouge">Gemfile</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>gem 'bunny', '~&gt; 2.3.1'
</code></pre>
</div>

<p>Then run a <code class="highlighter-rouge">bundle install</code>.</p>

<p>The <code class="highlighter-rouge">bunny</code> gem gives us a lot of great functionality out of the box like robust connection handling. If the connection to RabbitMQ drops, <code class="highlighter-rouge">bunny</code> will attempt to reconnect until the connection is restored. The <code class="highlighter-rouge">bunny</code> gem also gives us an easy API for leveraging RabbitMQ from within our application.</p>

<p>The connection to RabbitMQ should be established at application startup and remain open for the duration of the application’s lifetime. To this end we create a MessagingService singleton class:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># The messaging service class implements the Singleton pattern</span>
<span class="k">class</span> <span class="nc">MessagingService</span>

  <span class="c1"># Class variable holding the instance of the class</span>
  <span class="vc">@@instance</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="c1"># Set the connection object to an instance variable on the object</span>
    <span class="vi">@connection</span> <span class="o">=</span> <span class="no">Bunny</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:host</span> <span class="o">=&gt;</span> <span class="no">Settings</span><span class="p">.</span><span class="nf">rabbitmq</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="ss">:port</span> <span class="o">=&gt;</span> <span class="no">Settings</span><span class="p">.</span><span class="nf">rabbitmq</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span>
    <span class="vi">@connection</span><span class="p">.</span><span class="nf">start</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instance</span>
    <span class="vc">@@instance</span> <span class="o">||=</span> <span class="no">MessagingService</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">connection</span>
    <span class="vi">@connection</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># Acquire the connection</span>
<span class="no">MessagingService</span><span class="p">.</span><span class="nf">instance</span></code></pre></figure>

<p>By using the Singleton pattern for the <code class="highlighter-rouge">MessageService</code> class we can ensure that the connection is not closed resulting in us having to reconnect every time we want to send an email. The <code class="highlighter-rouge">EmailQueueService</code> class uses the connection provided by the <code class="highlighter-rouge">MessageService</code> class to create a queue for our email pipeline:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'messaging_service'</span>

<span class="c1"># Email queue service also implements the Singleton pattern</span>
<span class="k">class</span> <span class="nc">EmailQueueService</span>

  <span class="vc">@@instance</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="c1"># We can get the connection from the MassagingService</span>
    <span class="vi">@connection</span> <span class="o">=</span> <span class="no">MessagingService</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">connection</span>
    <span class="c1"># Create a channel. Since the application is single-threaded, all communication</span>
    <span class="c1"># will flow through this single channel</span>
    <span class="vi">@channel</span> <span class="o">=</span> <span class="vi">@connection</span><span class="p">.</span><span class="nf">create_channel</span>
    <span class="c1"># Create a queue with a name that was defined in the settings.yml file</span>
    <span class="vi">@queue</span> <span class="o">=</span> <span class="vi">@channel</span><span class="p">.</span><span class="nf">queue</span><span class="p">(</span><span class="no">Settings</span><span class="p">.</span><span class="nf">queues</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">:durable</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:auto_delete</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instance</span>
    <span class="vc">@@instance</span> <span class="o">||=</span> <span class="no">EmailQueueService</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="c1"># Method for adding a message object to the queue</span>
  <span class="c1"># The message object is serialized to a JSON string</span>
  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">msg_object</span><span class="p">)</span>
    <span class="vi">@queue</span><span class="p">.</span><span class="nf">publish</span><span class="p">(</span><span class="no">Oj</span><span class="p">.</span><span class="nf">dump</span><span class="p">(</span><span class="n">msg_object</span><span class="p">),</span> <span class="ss">:persistent</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># Initialze the object</span>
<span class="no">EmailQueueService</span><span class="p">.</span><span class="nf">instance</span></code></pre></figure>

<p>The <code class="highlighter-rouge">AccountActivationService</code> class is specific to sending account activation emails when new users sign up:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require_relative</span> <span class="s1">'email_queue_service'</span>

<span class="c1"># Service specific to sending account activation emails</span>
<span class="k">class</span> <span class="nc">AccountActivationService</span>

  <span class="vc">@@instance</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="c1"># Load the email template into memory</span>
    <span class="vi">@text_template</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'app/views/email/account_activation_email.text.erb'</span><span class="p">).</span><span class="nf">read</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instance</span>
    <span class="vc">@@instance</span> <span class="o">||=</span> <span class="no">AccountActivationService</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Set template variables</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
    <span class="vi">@settings</span> <span class="o">=</span> <span class="no">Settings</span>

    <span class="n">msg_object</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">msg_object</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_email_address_string</span><span class="p">(</span><span class="ss">first_name: </span><span class="n">user</span><span class="p">.</span><span class="nf">first_name</span><span class="p">,</span> <span class="ss">last_name: </span><span class="n">user</span><span class="p">.</span><span class="nf">last_name</span><span class="p">,</span> <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
    <span class="n">msg_object</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_email_address_string</span><span class="p">(</span><span class="ss">first_name: </span><span class="no">Settings</span><span class="p">.</span><span class="nf">app</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="ss">email: </span><span class="no">Settings</span><span class="p">.</span><span class="nf">app</span><span class="p">.</span><span class="nf">emails</span><span class="p">.</span><span class="nf">activation</span><span class="p">)</span>
    <span class="n">msg_object</span><span class="p">[</span><span class="s1">'subject'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Account Activation"</span>
    <span class="c1"># Pass the object binding to the template so that it can access the instance variables</span>
    <span class="n">msg_object</span><span class="p">[</span><span class="s1">'text'</span><span class="p">]</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@text_template</span><span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
    <span class="c1"># Add the message object to the email queue</span>
    <span class="no">EmailQueueService</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">msg_object</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># Create an email address string of this form: "Timmy Droptables &lt;timmy@tables.com&gt;"</span>
  <span class="k">def</span> <span class="nf">create_email_address_string</span><span class="p">(</span><span class="ss">first_name: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">last_name: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">email: </span><span class="kp">nil</span><span class="p">)</span>
    <span class="p">[</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="s2">"&lt;</span><span class="si">#{</span><span class="n">email</span><span class="si">}</span><span class="s2">&gt;"</span><span class="p">].</span><span class="nf">compact</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">" "</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># Initialize the object</span>
<span class="no">AccountActivationService</span><span class="p">.</span><span class="nf">instance</span></code></pre></figure>

<h3 id="the-node-layer">The Node Layer</h3>

<p>The <code class="highlighter-rouge">package.json</code> for the project is as follows:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nt">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"email_worker"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Email sender microservice for the Mailgun API."</span><span class="p">,</span><span class="w">
  </span><span class="nt">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"main.js"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"amqplib"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.4.2"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"lodash"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.13.1"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"mime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1.3.4"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^2.72.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"winston"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^2.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"yamljs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.2.7"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"devDependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"chai"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^3.5.0"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"mocha"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^2.5.3"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"mock-require"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1.3.0"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node main.js"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node node_modules/.bin/mocha"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nt">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Sebastian Coetzee &lt;mail@sebastiancoetzee.com&gt;"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>The <code class="highlighter-rouge">amqplib</code> library is used to communicate with RabbitMQ, <code class="highlighter-rouge">lodash</code> as a helper library, <code class="highlighter-rouge">mime</code> to get the mime types of the email attachments, <code class="highlighter-rouge">request</code> for sending the HTTP requests, <code class="highlighter-rouge">winston</code> for logging and <code class="highlighter-rouge">yamljs</code> to parse the <code class="highlighter-rouge">config.yml</code> file containing settings.</p>

<p>The bulk of the work is done in the <code class="highlighter-rouge">worker.js</code> file:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./config'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./logger'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mime</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mime'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'lodash'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="c1">// Holds the number of active HTTP connections to the Mailgun API.</span>
<span class="c1">// I am limiting the max number of open HTTP connections so that</span>
<span class="c1">// the worker doesn't get overloaded and so that the work gets spread</span>
<span class="c1">// out over multiple workers.</span>
<span class="kd">var</span> <span class="nx">conns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>

  <span class="c1">// Gets a new message from RabbitMQ if one is available</span>
  <span class="na">getMessage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">channel</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">conns</span> <span class="o">&gt;=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">max_http_connections</span><span class="p">){</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">channel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">queue</span><span class="p">,</span> <span class="p">{},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Message picked up."</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="p">[</span><span class="s1">'content'</span><span class="p">]));</span>
          <span class="nx">that</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>

          <span class="c1">// Add to the count of active connections</span>
          <span class="nx">conns</span><span class="o">++</span><span class="p">;</span>
          <span class="c1">// Only get a new message from RabbitMQ if there are connection slots available</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">conns</span> <span class="o">&lt;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">max_http_connections</span><span class="p">){</span>
            <span class="c1">// Recursive call</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">getMessage</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">);</span>
  <span class="p">},</span>

  <span class="c1">// Accessor method for the number of active HTTP connections</span>
  <span class="na">getConnections</span><span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">conns</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="c1">// The request library expects a form data object in this format</span>
  <span class="na">buildFormData</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg_obj</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">formData</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">msg_obj</span><span class="p">,</span> <span class="p">[</span><span class="s1">'from'</span><span class="p">,</span> <span class="s1">'to'</span><span class="p">,</span> <span class="s1">'cc'</span><span class="p">,</span> <span class="s1">'bcc'</span><span class="p">,</span> <span class="s1">'subject'</span><span class="p">,</span> <span class="s1">'text'</span><span class="p">,</span> <span class="s1">'html'</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">msg_obj</span><span class="p">[</span><span class="s1">'file_path'</span><span class="p">]){</span>
      <span class="nx">formData</span><span class="p">[</span><span class="s1">'attachment'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">value</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">msg_obj</span><span class="p">[</span><span class="s1">'file_path'</span><span class="p">]),</span>
        <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">filename</span><span class="p">:</span> <span class="nx">msg_obj</span><span class="p">[</span><span class="s1">'file_name'</span><span class="p">],</span>
          <span class="na">contentType</span><span class="p">:</span> <span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">msg_obj</span><span class="p">[</span><span class="s1">'file_name'</span><span class="p">])</span>
        <span class="p">}</span>
      <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">formData</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="c1">// Send the email using the Mailgun API</span>
  <span class="na">send</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">msg_obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">content</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="kd">var</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildFormData</span><span class="p">(</span><span class="nx">msg_obj</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">auth</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">'user'</span><span class="p">:</span> <span class="s1">'api'</span><span class="p">,</span>
      <span class="s1">'pass'</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">api_key</span>
    <span class="p">}</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
      <span class="p">{</span>
        <span class="na">url</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">api_base_url</span> <span class="o">+</span> <span class="s2">"/messages"</span><span class="p">,</span>
        <span class="na">formData</span><span class="p">:</span> <span class="nx">formData</span><span class="p">,</span>
        <span class="na">auth</span><span class="p">:</span> <span class="nx">auth</span>
      <span class="p">},</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">){</span>
        <span class="c1">// Return a possible connection to the pool</span>
        <span class="nx">conns</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"An error occured while posting to the Mailgun API: "</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>

          <span class="c1">// Acknowledge that the handling of the message failed.</span>
          <span class="k">return</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">nack</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Successfully sent mail."</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="p">[</span><span class="s1">'content'</span><span class="p">]));</span>

        <span class="c1">// Acknowledge that the handling of the message succeeded.</span>
        <span class="nx">channel</span><span class="p">.</span><span class="nx">ack</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="p">}</span>

<span class="p">};</span></code></pre></figure>

<p>The worker is the started using the <code class="highlighter-rouge">main.js</code> file:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./config'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./logger'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">worker</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./worker'</span><span class="p">);</span>

<span class="nx">require</span><span class="p">(</span><span class="s1">'amqplib/callback_api'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">connect</span><span class="p">(</span>
    <span class="s1">'amqp://'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">rabbitmq_host</span> <span class="o">+</span> <span class="s1">':'</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">rabbitmq_port</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">conn</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"Could not create connection."</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">conn</span><span class="p">.</span><span class="nx">createChannel</span><span class="p">(</span>
        <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">"Could not create channel."</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
            <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nx">channel</span><span class="p">.</span><span class="nx">assertQueue</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">queue</span><span class="p">);</span>
          <span class="nx">setInterval</span><span class="p">(</span>
            <span class="kd">function</span><span class="p">(){</span>
              <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Poll. HTTP connections: "</span> <span class="o">+</span> <span class="nx">worker</span><span class="p">.</span><span class="nx">getConnections</span><span class="p">(),</span> <span class="kc">null</span><span class="p">);</span>
              <span class="nx">worker</span><span class="p">.</span><span class="nx">getMessage</span><span class="p">(</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">polling_rate</span>
          <span class="p">);</span>
        <span class="p">}</span>
      <span class="p">);</span>
    <span class="p">}</span>
  <span class="p">);</span></code></pre></figure>

<h3 id="putting-it-all-together">Putting it all together</h3>

<p>In order to send email accross the queue, the following code is executed from the Rails <code class="highlighter-rouge">UsersController</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="n">validate_required_params</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">.</span><span class="nf">save</span>

      <span class="c1"># Send the user the activation email</span>
      <span class="no">AccountActivationService</span><span class="p">.</span><span class="nf">instance</span><span class="p">.</span><span class="nf">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

      <span class="n">render_json</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="no">StatusMessage</span><span class="o">::</span><span class="no">SUCCESS</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s2">"User successfully registered. Please check your email for activation instructions."</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">render_json</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="no">StatusMessage</span><span class="o">::</span><span class="no">ERROR</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s2">"User registration failed."</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<h3 id="summary">Summary</h3>

<p><a href="https://nodejs.org">Node.js</a> provides first-class support for asynchronous execution of HTTP requests. This makes it a great technology to use for sending emails via the <a href="https://www.mailgun.com/">Mailgun</a> API. <a href="http://rubyonrails.org/">Ruby on Rails</a> is great for building web applications. We want to leverage the best features of these two technologies together and we implemented <a href="https://www.rabbitmq.com">RabbitMQ</a> to enable robust communication between the Ruby and the JavaScript layers.</p>

      </article>

      

      

      <ul class="pager blog-pager">
        
        <li class="previous">
          <a href="/2016-03-02-continuous-deployment-of-java-microservices-using-teamcity" data-toggle="tooltip" data-placement="top" title="Continuous Delivery of Java Microservices">&larr; Previous Post</a>
        </li>
        
        
        <li class="next">
          <a href="/2016-11-13-best-wifi-in-cape-town-coffee-shops" data-toggle="tooltip" data-placement="top" title="Top 4 best WiFi coffee shops in Cape Town">Next Post &rarr;</a>
        </li>
        
      </ul>

      
        <div class="disqus-comments">
          

        </div>
      
    </div>
  </div>
</div>

    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/sebcoetzee" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
	  
      
		  
          <li>
            <a href="mailto:seb.coetzee@gmail.com" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
          <li>
            <a href="https://linkedin.com/in/in/sebastiancoetzee" title="LinkedIn">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
		  
      
      
      
      
		  
        </ul>
        <p class="copyright text-muted">
		  Sebastian Coetzee
		  &nbsp;&bull;&nbsp;
		  2024

		  
		  &nbsp;&bull;&nbsp;
		  <a href="https://sebastiancoetzee.com">sebastiancoetzee.com</a>
		  
	    </p>
	        <!-- Please don't remove this, keep my open source work credited :) -->
		<p class="theme-by text-muted">
		  Theme by
		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
		</p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/js/main.js"></script>
    
  



	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		ga('create', 'UA-28366174-2', 'auto');
		ga('send', 'pageview');
	</script>
	<!-- End Google Analytics -->


  
  </body>
</html>
